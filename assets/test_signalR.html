<html>

<head>
    <title>Serverless Chat</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css">
    <script>
        window.apiBaseUrl = 'https://fun-mst-notifiable.azurewebsites.net';
    </script>
    <style>
        .slide-fade-enter-active,
        .slide-fade-leave-active {
            transition: all 1s ease;
        }

        .slide-fade-enter,
        .slide-fade-leave-to {
            height: 0px;
            overflow-y: hidden;
            opacity: 0;
        }
    </style>
</head>

<body>

    <div id="div1"></div>


    <script src="https://cdn.jsdelivr.net/npm/@aspnet/signalr@1.1.4/dist/browser/signalr.js"></script>


    <script>

        function getConnectionInfo(info) {
            // make compatible with old and new SignalRConnectionInfo
            info.accessToken = info.accessToken || info.accessKey;
            info.url = info.url || info.endpoint;


            const options = {
                accessTokenFactory: () => info.accessToken
            };

            const connection = new signalR.HubConnectionBuilder()
                .withUrl(info.url, options)
                .configureLogging(signalR.LogLevel.Information)
                .build();

            connection.on('notify', newMessage);
            connection.onclose(() => console.log('disconnected'));

            console.log('connecting...');
            connection.start()
                .then(() => console.log('connected!'))
                .catch(console.error);

        };




        function getConnectionInfo() {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                console.log(this);
                if (this.readyState == 4 && this.status == 200) {
                    // Typical action to be performed when the document is ready:
                    var myResponse = JSON.parse(this.responseText);
                    getConnectionInfo(myResponse);
                }
            };
            xhttp.open("GET", `${apiBaseUrl}/api/negotiate`, true);
            xhttp.send();
        }

        function newMessage(message) {
            // crea un nuovo elemento div
            var newDiv = document.createElement("div");
            // ed assegnargli un contenuto
            var newContent = document.createTextNode(message);
            // aggiungi il nodo di testo al div appena creato
            newDiv.appendChild(newContent);

            // aggiungi l'elemento appena creato e il suo contenuto nel DOM
            var currentDiv = document.getElementById("div1");
            document.body.insertBefore(newDiv, currentDiv);
        }

    </script>
</body>

</html>