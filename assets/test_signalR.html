<html>

<head>
    <title>Serverless Chat</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css">
    <script>
        window.apiBaseUrl = 'https://fun-mst-notifiable.azurewebsites.net/api/negotiate';
    </script>
    <style>
        .slide-fade-enter-active,
        .slide-fade-leave-active {
            transition: all 1s ease;
        }

        .slide-fade-enter,
        .slide-fade-leave-to {
            height: 0px;
            overflow-y: hidden;
            opacity: 0;
        }
    </style>
</head>

<body>
    <p>&nbsp;</p>
    <div id="app" class="container">
        <h3>Serverless chat</h3>
        <div class="row" v-if="ready">
            <div class="signalr-demo col-sm">
                <hr />

            </div>
        </div>
        <div class="row" v-if="!ready">
            <div class="col-sm">
                <div>Loading...</div>
            </div>
        </div>
        <div v-if="ready">
            <transition-group name="slide-fade" tag="div">
                <div class="row" v-for="message in messages" v-bind:key="message.id">
                    <div class="col-sm">
                        <hr />
                        <div>
                            <div style="display: inline-block; padding-left: 12px;">
                                <div>
                                    <span class="text-info small"><strong>{{ message.sender }}</strong></span>
                                </div>
                                <div>
                                    {{ message.text }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
        </div>
        </transition-group>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/@aspnet/signalr@1.0.3/dist/browser/signalr.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@0.18.0/dist/axios.min.js"></script>

    <script>






        getConnectionInfo().then(info => {
            // make compatible with old and new SignalRConnectionInfo
            info.accessToken = info.accessToken || info.accessKey;
            info.url = info.url || info.endpoint;


            const options = {
                accessTokenFactory: () => info.accessToken
            };

            const connection = new signalR.HubConnectionBuilder()
                .withUrl(info.url, options)
                .configureLogging(signalR.LogLevel.Information)
                .build();

            connection.on('newMessage', newMessage);
            connection.onclose(() => console.log('disconnected'));

            console.log('connecting...');
            connection.start()
                .then(() => console.log('connected!'))
                .catch(console.error);

        }).catch(alert);



        function getConnectionInfo() {
            return axios.post(`${apiBaseUrl}/api/negotiate`)
                .then(resp => resp.data);
        }




    </script>
</body>

</html>